<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DJ Roster — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy: #2B3990;
  --navy-dark: #1a2570;
  --teal: #5DB8C0;
  --teal-light: #eaf6f7;
  --orange: #F15A29;
  --love-pink: #e91e8c;
  --love-dark: #880e4f;
  --love-light: #fce4ec;
  --white: #ffffff;
  --bg: #f0f2f8;
  --border: #dde2f0;
  --text: #1c2340;
  --text-mid: #5a6380;
  --text-light: #9aa0b8;
  --radius: 12px;
  --shadow: 0 2px 16px rgba(43,57,144,0.10);
}

html, body { height: 100%; }
body { font-family: 'Montserrat', sans-serif; background: #0b1020; color: var(--text); min-height: 100vh; }

/* ── SHARED BACKGROUND ── */
.bg-fixed {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
}
.bg-orb {
  position: absolute; border-radius: 50%; filter: blur(100px);
  animation: drift 14s ease-in-out infinite alternate;
}
.bg-orb:nth-child(1) { width: 700px; height: 700px; background: radial-gradient(circle, #2B3990 0%, transparent 70%); top: -200px; left: -200px; opacity: 0.55; animation-delay: 0s; }
.bg-orb:nth-child(2) { width: 500px; height: 500px; background: radial-gradient(circle, #5DB8C0 0%, transparent 70%); bottom: -150px; right: -100px; opacity: 0.3; animation-delay: -5s; }
.bg-orb:nth-child(3) { width: 350px; height: 350px; background: radial-gradient(circle, #F15A29 0%, transparent 70%); top: 45%; left: 55%; opacity: 0.12; animation-delay: -9s; }
@keyframes drift { from { transform: translate(0,0); } to { transform: translate(40px,-50px); } }

/* ── LOGIN ── */
.login-wrap {
  min-height: 100vh; position: relative; z-index: 1;
  display: flex; align-items: center; justify-content: center;
}
.login-box {
  background: rgba(255,255,255,0.07);
  backdrop-filter: blur(28px); -webkit-backdrop-filter: blur(28px);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 24px; padding: 48px 40px;
  width: 360px; text-align: center;
  box-shadow: 0 32px 80px rgba(0,0,0,0.5);
  animation: fadeUp 0.7s ease both;
}
.login-icon { font-size: 32px; margin-bottom: 14px; }
.login-box h1 { font-size: 26px; font-weight: 900; color: white; margin-bottom: 4px; }
.login-box p { font-size: 12px; color: rgba(255,255,255,0.4); font-weight: 500; margin-bottom: 32px; }
.login-box input {
  width: 100%; padding: 14px 18px;
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 10px; font-family: 'Montserrat', sans-serif;
  font-size: 15px; font-weight: 400; text-align: center;
  letter-spacing: 0.05em; outline: none; margin-bottom: 12px;
  background: rgba(255,255,255,0.08); color: white;
  transition: border-color 0.2s, background 0.2s;
}
.login-box input::placeholder { color: rgba(255,255,255,0.3); }
.login-box input:focus { border-color: var(--teal); background: rgba(255,255,255,0.12); }
.login-box button {
  width: 100%; padding: 14px;
  background: rgba(93,184,192,0.2);
  border: 1px solid rgba(93,184,192,0.4);
  color: white; border-radius: 10px;
  font-family: 'Montserrat', sans-serif; font-size: 14px; font-weight: 800;
  cursor: pointer; transition: background 0.2s, border-color 0.2s;
}
.login-box button:hover { background: rgba(93,184,192,0.35); border-color: rgba(93,184,192,0.7); }
.login-error { color: var(--orange); font-size: 12px; font-weight: 600; margin-top: 10px; display: none; }

@keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }

/* ── APP CHROME ── */
.app { display: none; flex-direction: column; min-height: 100vh; position: relative; z-index: 1; }
.app.visible { display: flex; }

.app-header {
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  color: white; padding: 0 24px; height: 56px;
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.back-btn-roster {
  display: inline-flex; align-items: center;
  padding: 5px 12px; border-radius: 20px;
  font-size: 11px; font-weight: 700; letter-spacing: 0.05em;
  color: rgba(255,255,255,0.45);
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  text-decoration: none; transition: all 0.2s; white-space: nowrap;
}
.back-btn-roster:hover { color: white; background: rgba(255,255,255,0.14); border-color: rgba(255,255,255,0.25); }

.app-header-left { display: flex; align-items: center; gap: 12px; }
.app-header h1 { font-size: 17px; font-weight: 900; letter-spacing: -0.01em; color: white; }
.header-badge {
  background: rgba(255,255,255,0.12); padding: 3px 10px;
  border-radius: 20px; font-size: 10px; font-weight: 700;
  letter-spacing: 0.08em; text-transform: uppercase; color: rgba(255,255,255,0.7);
}
.month-nav { display: flex; align-items: center; gap: 8px; }
.month-nav button {
  background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
  color: white; width: 28px; height: 28px; border-radius: 6px; cursor: pointer;
  font-size: 14px; display: flex; align-items: center; justify-content: center;
  transition: background 0.15s;
}
.month-nav button:hover { background: rgba(255,255,255,0.2); }
.month-label { font-size: 13px; font-weight: 800; min-width: 130px; text-align: center; color: white; }

.venue-bar {
  background: rgba(255,255,255,0.04);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  padding: 0 24px; display: flex; align-items: flex-end; gap: 4px; flex-shrink: 0;
}
.venue-tab {
  padding: 12px 24px; border: none; background: none;
  font-family: 'Montserrat', sans-serif; font-size: 13px; font-weight: 700;
  color: rgba(255,255,255,0.35); cursor: pointer;
  border-bottom: 3px solid transparent; margin-bottom: -1px; transition: all 0.2s;
}
.venue-tab:hover { color: rgba(255,255,255,0.7); }
.venue-tab.active { color: white; border-bottom-color: var(--teal); }
.venue-tab.love.active { color: white; border-bottom-color: var(--love-pink); }
.venue-tab.active[id="tabHours"] { color: white; border-bottom-color: #4caf50; }

.main-content { flex: 1; overflow: auto; padding: 20px 24px; }

.grid-wrap { overflow-x: auto; border-radius: var(--radius); box-shadow: var(--shadow); background: white; }
.roster-table { border-collapse: collapse; min-width: 100%; font-size: 11px; }
.roster-table thead th {
  padding: 10px 6px; text-align: center; font-weight: 800; font-size: 10px;
  white-space: nowrap; position: sticky; top: 0; z-index: 10;
  border-bottom: 2px solid var(--border); letter-spacing: 0.03em;
}
.th-date {
  background: var(--navy) !important; color: white !important;
  min-width: 110px; text-align: left !important; padding-left: 14px !important;
  position: sticky !important; left: 0 !important; z-index: 20 !important;
}
.th-arkbar { background: var(--teal-light); color: var(--navy); min-width: 82px; }
.th-hip { background: var(--orange); color: white; min-width: 82px; }
.th-love { background: var(--love-light); color: var(--love-dark); min-width: 82px; }

.roster-table tbody tr:hover { background: #f8f9ff; }
.roster-table tbody tr:nth-child(even) { background: #fafbff; }
.roster-table tbody tr:nth-child(even):hover { background: #f4f5ff; }

.td-date {
  padding: 8px 14px; font-weight: 700; font-size: 11px; color: var(--text);
  white-space: nowrap; border-right: 2px solid var(--border);
  position: sticky; left: 0; z-index: 5; min-width: 110px;
  background: white;
}
.roster-table tbody tr:nth-child(even) .td-date { background: #fafbff; }
.roster-table tbody tr:hover .td-date { background: #f8f9ff; }
.td-date .dow { color: var(--teal); font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; display: block; }
.td-date.weekend .dow { color: var(--orange); }
.td-slot { padding: 4px; border: 1px solid #eef0f8; min-width: 82px; vertical-align: middle; }
.td-slot.hip-slot { background: rgba(241,90,41,0.04); border-color: rgba(241,90,41,0.15); }
.td-slot.love-slot { background: rgba(233,30,140,0.03); border-color: rgba(233,30,140,0.12); }
.td-slot.empty-slot { background: #f9f9f9; }

.slot-select {
  width: 100%; padding: 5px 3px; border: 1.5px solid transparent;
  border-radius: 6px; font-family: 'Montserrat', sans-serif;
  font-size: 10px; font-weight: 700; color: var(--text);
  background: transparent; cursor: pointer; outline: none;
  transition: all 0.15s; appearance: none; -webkit-appearance: none;
  text-align: center; min-height: 28px;
}
.slot-select:hover { border-color: var(--teal); background: var(--teal-light); }
.slot-select:focus { border-color: var(--navy); background: white; box-shadow: 0 0 0 3px rgba(43,57,144,0.1); }
.slot-select.assigned { color: white !important; font-weight: 800 !important; }
.slot-select.unassigned { color: var(--text-light); }
.slot-select.no-avail { background: #f5f5f5; color: #ccc; cursor: not-allowed; font-size: 10px; }

.th-section-label { padding: 6px; font-size: 11px; font-weight: 800; text-align: center; letter-spacing: 0.05em; }

.status-bar {
  background: rgba(255,255,255,0.05);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border-top: 1px solid rgba(255,255,255,0.08);
  padding: 10px 24px; display: flex; align-items: center; gap: 20px;
  flex-shrink: 0; font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.45);
}
.status-pill {
  display: flex; align-items: center; gap: 6px;
  padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 11px;
}
.status-pill.draft { background: rgba(230,81,0,0.2); color: #ffab40; border: 1px solid rgba(230,81,0,0.3); }
.status-pill.published { background: rgba(46,125,50,0.2); color: #69f0ae; border: 1px solid rgba(46,125,50,0.3); }
.status-bar-right { margin-left: auto; display: flex; gap: 10px; }
.btn-sm {
  padding: 7px 16px; border-radius: 8px; font-family: 'Montserrat', sans-serif;
  font-size: 11px; font-weight: 700; cursor: pointer; transition: all 0.15s;
  border: 1px solid rgba(255,255,255,0.15);
  background: rgba(255,255,255,0.08); color: white;
  backdrop-filter: blur(10px);
}
.btn-sm:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3); }
.btn-publish { background: rgba(43,57,144,0.6); border-color: rgba(93,184,192,0.5); color: white; }
.btn-publish:hover { background: rgba(43,57,144,0.85); border-color: var(--teal); }
.btn-suggest { background: rgba(93,184,192,0.15); border-color: rgba(93,184,192,0.4); color: var(--teal); }
.btn-suggest:hover { background: rgba(93,184,192,0.3); border-color: var(--teal); color: white; }
.btn-clear { background: rgba(241,90,41,0.12); border-color: rgba(241,90,41,0.35); color: #ff8a65; }
.btn-clear:hover { background: rgba(241,90,41,0.25); border-color: var(--orange); color: white; }

.loading { text-align: center; padding: 80px 40px; color: rgba(255,255,255,0.4); font-weight: 600; font-size: 13px; }
.spinner {
  width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.1);
  border-top-color: var(--teal); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }

.toast {
  position: fixed; bottom: 24px; right: 24px;
  background: rgba(30,40,80,0.95);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.15);
  color: white; padding: 12px 20px; border-radius: 10px;
  font-size: 12px; font-weight: 700; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  transform: translateY(80px); opacity: 0; transition: all 0.3s ease; z-index: 1000;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: rgba(27,94,32,0.95); border-color: rgba(105,240,174,0.3); }
.toast.error { background: rgba(183,28,28,0.95); border-color: rgba(255,100,100,0.3); }

.grid-wrap { overflow-x: auto; border-radius: var(--radius); background: white; box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
.grid-wrap::-webkit-scrollbar { height: 6px; }
.grid-wrap::-webkit-scrollbar-track { background: transparent; }
.grid-wrap::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

/* LOCKED STATE */
.roster-locked .slot-select:not(.no-avail) {
  pointer-events: none;
  opacity: 0.95;
}
.roster-locked .slot-select.unassigned {
  opacity: 0.4;
}

/* HOURS PAGE */
.hours-wrap { display: flex; flex-direction: column; gap: 20px; }
.summary-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 14px; }
.summary-card {
  background: rgba(255,255,255,0.07);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius); padding: 18px;
}
.summary-card .card-label { font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; }
.summary-card .card-value { font-size: 26px; font-weight: 900; color: white; }
.summary-card .card-sub { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.35); margin-top: 2px; }
.hours-table-wrap {
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius); overflow: hidden;
}
.hours-table-header { padding: 14px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: space-between; }
.hours-table-header h2 { font-size: 14px; font-weight: 800; color: white; }
.hours-table { width: 100%; border-collapse: collapse; }
.hours-table thead th { padding: 9px 14px; text-align: left; font-size: 10px; font-weight: 800; color: rgba(255,255,255,0.35); text-transform: uppercase; letter-spacing: 0.08em; border-bottom: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); }
.hours-table thead th.right { text-align: right; }
.hours-table tbody tr { border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.1s; }
.hours-table tbody tr:last-child { border-bottom: none; }
.hours-table tbody tr:hover { background: rgba(255,255,255,0.04); }
.hours-table tbody td { padding: 11px 14px; font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.8); }
.hours-table tbody td.right { text-align: right; }
.dj-name-cell { display: flex; align-items: center; gap: 10px; }
.dj-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.dj-name { font-weight: 700; font-size: 12px; color: white; }
.hours-bar-wrap { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.hours-bar-bg { flex: 1; height: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; min-width: 60px; }
.hours-bar-fill { height: 100%; border-radius: 3px; background: var(--teal); }
.hours-bar-fill.resident { background: #7c83ff; }
.hours-bar-fill.zero { background: rgba(255,255,255,0.08); }
.hours-val { font-size: 12px; font-weight: 800; color: white; min-width: 30px; text-align: right; }
.badge { padding: 2px 7px; border-radius: 20px; font-size: 9px; font-weight: 800; text-transform: uppercase; }
.badge-low { background: rgba(230,81,0,0.25); color: #ffab40; border: 1px solid rgba(230,81,0,0.3); }
.badge-ok { background: rgba(46,125,50,0.25); color: #69f0ae; border: 1px solid rgba(46,125,50,0.3); }
.target-note { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.3); padding: 10px 20px; background: rgba(255,255,255,0.03); border-top: 1px solid rgba(255,255,255,0.06); }
.totals-row { background: rgba(255,255,255,0.05) !important; }
.totals-row td { font-weight: 800 !important; color: white !important; }

@media (max-width: 600px) {
  .summary-row { grid-template-columns: 1fr 1fr; }
  .hours-table thead th, .hours-table tbody td { padding: 8px 10px; font-size: 11px; }
  .hours-table-wrap { overflow-x: auto; }
  .hours-table { min-width: 520px; }
  .hours-wrap { padding-right: 4px; }
}
@media (max-width: 768px) {
  .app-header {
    height: auto;
    padding: 10px 14px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .app-header-left { flex: 1; min-width: 0; }
  .app-header h1 {
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .header-badge { font-size: 9px; padding: 2px 7px; }
  .month-nav { width: 100%; justify-content: center; }
  .month-label { font-size: 12px; min-width: 110px; }
  .month-nav button { width: 32px; height: 32px; font-size: 16px; }

  .venue-bar { padding: 0 12px; }
  .venue-tab { padding: 10px 14px; font-size: 12px; }

  .main-content { padding: 10px; }

  .td-date { min-width: 72px; padding: 5px 8px; font-size: 10px; }
  .td-date .dow { font-size: 8px; }
  .td-slot { min-width: 70px; padding: 3px; }
  .slot-select { font-size: 9px; min-height: 26px; padding: 3px 2px; }
  .roster-table thead th { font-size: 9px; padding: 7px 3px; }
  .th-section-label { font-size: 9px; padding: 5px; }

  .status-bar {
    padding: 8px 12px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .status-bar-right {
    width: 100%;
    justify-content: flex-end;
    flex-wrap: wrap;
    gap: 6px;
  }
  .btn-sm { padding: 6px 12px; font-size: 10px; }
  .status-pill { font-size: 10px; }

  .toast { bottom: 12px; right: 12px; left: 12px; font-size: 11px; }
}

/* PRINT */
@media print {
  @page { size: A2 landscape; margin: 8mm; }
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
  body { background: white; font-size: 10px; }
  .login-wrap { display: none !important; }
  .app-header, .venue-bar, .status-bar { display: none !important; }
  .print-header { display: block !important; padding: 0 0 6px 0; margin-bottom: 6px; border-bottom: 2px solid #2B3990; font-size: 13px; }
  .main-content { padding: 0 !important; overflow: visible !important; flex: none; }
  .app { display: block !important; min-height: unset; }
  .grid-wrap { box-shadow: none; overflow: visible !important; border-radius: 0; }
  .roster-table { font-size: 7.5px; }
  .roster-table thead th { font-size: 7px; padding: 4px 3px; position: static; }
  .th-arkbar { background: #eaf6f7 !important; color: #2B3990 !important; }
  .th-hip { background: #F15A29 !important; color: white !important; }
  .th-love { background: #fce4ec !important; color: #880e4f !important; }
  .th-date { background: #2B3990 !important; color: white !important; }
  .th-section-label[style*="teal"] { background: #5DB8C0 !important; color: white !important; }
  .th-section-label[style*="orange"] { background: #F15A29 !important; color: white !important; }
  .th-section-label[style*="love-pink"] { background: #e91e8c !important; color: white !important; }
  .td-date { font-size: 7.5px; padding: 3px 5px; min-width: 55px; position: static; border-right: 1px solid #ccc; }
  .td-date .dow { font-size: 7px; }
  .td-slot { min-width: 50px; padding: 2px; border: 0.5px solid #eee; }
  .slot-select { font-size: 8px; padding: 3px 2px; min-height: 20px; border-radius: 3px; border: none; width: 100%; }
  .slot-select.assigned { color: white !important; font-weight: 800 !important; border-radius: 3px !important; }
  .slot-select.unassigned, .slot-select.no-avail { display: none; }
  .td-slot.empty-slot { background: #fafafa !important; }
  .hours-wrap, .summary-row { display: none !important; }
  .roster-table tbody tr:nth-child(even) { background: #fafbff !important; }
}
.print-header {
  display: none;
  text-align: center;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 800;
  color: var(--navy);
}
</style>
</head>
<body>

<div class="bg-fixed">
  <div class="bg-orb"></div>
  <div class="bg-orb"></div>
  <div class="bg-orb"></div>
</div>

<div class="login-wrap" id="loginWrap">
  <div class="login-box">
    <div class="login-icon" style="font-size:40px;margin-bottom:12px;">&#9835;</div>
    <h1>DJ Roster</h1>
    <p>Admin — ARKbar & Love Beach Club</p>
    <div style="position:relative;width:100%;">
      <input type="password" id="pwInput" placeholder="Password"
             onkeydown="if(event.key==='Enter') doLogin()"
             style="padding-right:52px;width:100%;box-sizing:border-box;">
      <span onclick="togglePwView()" id="pwToggle"
            style="position:absolute;right:14px;top:50%;transform:translateY(-50%);
                   cursor:pointer;user-select:none;z-index:10;line-height:0;
                   -webkit-tap-highlight-color:transparent;padding:6px;">
        <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
             viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
      </span>
    </div>
    <button onclick="doLogin()">Enter Admin</button>
    <div class="login-error" id="loginError">Incorrect password. Try again.</div>
  </div>
</div>

<div class="app" id="mainApp">
  <div class="app-header">
    <div class="app-header-left">
      <a href="/" class="back-btn-roster">← Portal</a>
      <div class="header-badge">Admin</div>
      <h1 id="headerTitle">ARKbar / HIP Roster</h1>
    </div>
    <div class="month-nav">
      <button onclick="changeMonth(-1)">◀</button>
      <div class="month-label" id="monthLabel">—</div>
      <button onclick="changeMonth(1)">▶</button>
    </div>
  </div>

  <div class="venue-bar">
    <button class="venue-tab active" id="tabArkbar" onclick="switchVenue('arkbar')">ARKbar / HIP</button>
    <button class="venue-tab love" id="tabLove" onclick="switchVenue('love')">Love Beach Club</button>
    <button class="venue-tab" id="tabHours" onclick="switchVenue('hours')">DJ Hours</button>
  </div>

  <div class="print-header" id="printHeader"></div>
  <div class="main-content" id="mainContent">
    <div class="loading"><div class="spinner"></div>Loading...</div>
  </div>

  <div class="status-bar" id="statusBarEl">
    <div class="status-pill draft" id="statusPill">● Draft</div>
    <span id="statusText">Unsaved changes will auto-save per cell</span>
    <div class="status-bar-right">
      <button class="btn-sm btn-suggest" onclick="suggestRoster()">Auto-suggest ARKbar</button>
      <button class="btn-sm" onclick="clearRoster()" style="background:#fff0f0;color:#c62828;border:1.5px solid #ef9a9a;">Clear Roster</button>
      <button class="btn-sm btn-publish" id="btnPublish" onclick="publishRoster()">Publish Roster</button>
      <button class="btn-sm" id="btnPrint" onclick="printRoster()" style="display:none;background:#2e7d32;color:white;">Print / PDF</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let currentVenue = 'arkbar';
let currentYear, currentMonth;
let availability = {};
let rosterAssignments = {};
let arkbarAssignments = {};
let hipAssignments    = {};
let loveAssignments   = {};
let residentBlackouts = {}; // { djName: { "2026-03-01": "full"|"morning" } }
let djList = [];

const MONTHS = ['January','February','March','April','May','June',
                'July','August','September','October','November','December'];
const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

const ARKBAR_SLOTS = [
  '14:00\u201315:00','15:00\u201316:00','16:00\u201317:00','17:00\u201318:00',
  '18:00\u201319:00','20:00\u201321:00','21:00\u201322:00',
  '22:00\u201323:00','23:00\u201300:00','00:00\u201301:00','01:00\u201302:00'
];
const HIP_SLOTS = [
  '21:00\u201322:00','22:00\u201323:00','23:00\u201300:00','00:00\u201301:00'
];
// Full ARKbar 14:00–02:00 — all slots auto-suggested, server blocks residents from HIP
const ARKBAR_AUTOSUGGEST_SLOTS = [
  '14:00–15:00','15:00–16:00','16:00–17:00','17:00–18:00',
  '18:00–19:00','20:00–21:00','21:00–22:00',
  '22:00–23:00','23:00–00:00','00:00–01:00','01:00–02:00'
];
const LOVE_WEEKDAY_SLOTS = [
  '14:00\u201315:00','15:00\u201316:00','16:00\u201317:00',
  '20:00\u201321:00','21:00\u201322:00','22:00\u201323:00'
];
const LOVE_SAT_SLOTS = [
  '14:00\u201315:00','15:00\u201316:00','16:00\u201317:00','17:00\u201318:00',
  '18:00\u201319:00','20:00\u201321:00','21:00\u201322:00',
  '22:00\u201323:00','23:00\u201300:00'
];

const ARKBAR_ONLY = ['Alex RedWhite','Raffo DJ','Sound Bogie'];
const LOVE_ONLY = ['Laina'];
const NO_HIP = ['Alex RedWhite', 'Raffo DJ', 'Sound Bogie'];
const RESIDENTS_LATE_NIGHT = ['Alex RedWhite', 'Raffo DJ'];
const SOUND_BOGIE_BLOCKED = ['14:00–15:00','15:00–16:00','16:00–17:00'];
const SOUND_BOGIE_RARE = ['17:00–18:00','18:00–19:00'];

const DJ_COLORS = {
  'Alex RedWhite': '#1565c0',
  'Raffo DJ':      '#6a1b9a',
  'Sound Bogie':   '#00695c',
  'Tony':          '#b71c1c',
  'Davoted':       '#e65100',
  'D.Davoted':     '#bf360c',
  'Pick':          '#558b2f',
  'Jessi':         '#f57f17',
  'Cocoa':         '#4e342e',
  'Mostyx':        '#0277bd',
  'Laina':         '#ad1457',
  'Buba':          '#00838f',
  'Vozka':         '#4527a0',
  'Sky':           '#2e7d32',
  'Tobi':          '#5d4037',
  'Spice':         '#c62828',
  'Guest DJ':      '#78909c',
};

window.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  currentYear = now.getFullYear();
  currentMonth = now.getMonth();
  updateMonthLabel();
});

// ── EYE TOGGLE — SVG, always white, works on all platforms ──
function togglePwView() {
  const inp = document.getElementById('pwInput');
  const icon = document.getElementById('eyeIcon');
  if (inp.type === 'password') {
    inp.type = 'text';
    // Eye with slash (password visible)
    icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
  } else {
    inp.type = 'password';
    // Eye open (password hidden)
    icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
  }
}

async function doLogin() {
  const pw = document.getElementById('pwInput').value;
  try {
    const res = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw })
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById('loginWrap').style.display = 'none';
      document.getElementById('mainApp').classList.add('visible');
      loadAll();
    } else {
      document.getElementById('loginError').style.display = 'block';
    }
  } catch(e) {
    document.getElementById('loginError').style.display = 'block';
    document.getElementById('loginError').textContent = 'Connection error.';
  }
}

function changeMonth(dir) {
  currentMonth += dir;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  if (currentMonth < 0)  { currentMonth = 11; currentYear--; }
  updateMonthLabel();
  loadAll();
}

function updateMonthLabel() {
  document.getElementById('monthLabel').textContent = `${MONTHS[currentMonth]} ${currentYear}`;
}

function getMonthString() {
  return `${MONTHS[currentMonth]} ${currentYear}`;
}

function switchVenue(venue) {
  currentVenue = venue;
  document.getElementById('tabArkbar').classList.toggle('active', venue === 'arkbar');
  document.getElementById('tabLove').classList.toggle('active', venue === 'love');
  document.getElementById('tabHours').classList.toggle('active', venue === 'hours');
  document.getElementById('headerTitle').textContent =
    venue === 'arkbar' ? 'ARKbar / HIP Roster' :
    venue === 'love'   ? 'Love Beach Club Roster' : 'DJ Hours';

  document.getElementById('statusBarEl').style.display = venue === 'hours' ? 'none' : '';

  if (venue === 'hours') {
    loadHours();
  } else {
    loadAll();
  }
}

async function loadAll() {
  document.getElementById('mainContent').innerHTML =
    '<div class="loading"><div class="spinner"></div>Loading roster...</div>';
  const month = getMonthString();
  try {
    // Load everything in parallel — ARKbar, HIP, Love all separate rosters
    const [availRes, arkbarRes, hipRes, loveRes, djRes] = await Promise.all([
      fetch(`/api/availability?month=${encodeURIComponent(month)}`),
      fetch(`/api/roster?venue=arkbar&month=${encodeURIComponent(month)}`),
      fetch(`/api/roster?venue=hip&month=${encodeURIComponent(month)}`),
      fetch(`/api/roster?venue=love&month=${encodeURIComponent(month)}`),
      fetch('/api/djs'),
    ]);
    const availData  = await availRes.json();
    const arkbarData = await arkbarRes.json();
    const hipData    = await hipRes.json();
    const loveData   = await loveRes.json();
    const djData     = await djRes.json();

    // availability map: { "2026-03-01": { "21:00–22:00": ["Pick", ...] } }
    availability = availData.availability || {};
    // blackouts from server: { "Alex RedWhite": { "2026-03-01": "full"|"morning" } }
    residentBlackouts = availData.blackouts || {};

    // Parse each venue roster into a flat key→dj map
    function parseRoster(rows) {
      const map = {};
      (rows || []).forEach(row => {
        if (row[0] && row[1] && row[2]) map[`${row[0]}|${row[1]}`] = row[2];
      });
      return map;
    }

    arkbarAssignments = parseRoster(arkbarData.roster);
    hipAssignments    = parseRoster(hipData.roster);
    loveAssignments   = parseRoster(loveData.roster);

    // rosterAssignments points to the current venue being viewed
    if (currentVenue === 'arkbar') rosterAssignments = arkbarAssignments;
    else if (currentVenue === 'love') rosterAssignments = loveAssignments;

    djList = djData.djs || [];
    renderGrid();
  } catch(e) {
    document.getElementById('mainContent').innerHTML =
      `<div class="loading">Error loading data: ${e.message}</div>`;
  }
}

function renderGrid() {
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const isLove = currentVenue === 'love';

  let venueHeaderRow = '';
  let slotHeaderRow = '<th class="th-date">Date</th>';

  if (!isLove) {
    venueHeaderRow = `
      <tr>
        <th class="th-date" style="border-bottom:none;"></th>
        <th colspan="${ARKBAR_SLOTS.length}" class="th-section-label" style="background:var(--teal);color:white;">
          ARKbar Beach Club &nbsp;·&nbsp; 14:00 – 02:00
        </th>
        <th colspan="${HIP_SLOTS.length}" class="th-section-label" style="background:var(--orange);color:white;">
          HIP Restaurant &nbsp;·&nbsp; 21:00 – 01:00
        </th>
      </tr>`;
    ARKBAR_SLOTS.forEach(s => slotHeaderRow += `<th class="th-arkbar">${s}</th>`);
    HIP_SLOTS.forEach(s => slotHeaderRow += `<th class="th-hip">${s}</th>`);
  } else {
    venueHeaderRow = `
      <tr>
        <th class="th-date" style="border-bottom:none;background:var(--love-dark)!important;"></th>
        <th colspan="${LOVE_SAT_SLOTS.length}" class="th-section-label" style="background:var(--love-pink);color:white;">
          Love Beach Club &nbsp;·&nbsp; Weekdays 14:00–17:00 &amp; 20:00–23:00 &nbsp;|&nbsp; Saturdays 14:00–00:00
        </th>
      </tr>`;
    LOVE_SAT_SLOTS.forEach(s => slotHeaderRow += `<th class="th-love">${s}</th>`);
  }

  let bodyRows = '';
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(currentYear, currentMonth, d);
    const dow = date.getDay();
    const isSat = dow === 6;
    const isWeekend = isSat || dow === 0;
    const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

    let cells = '';
    if (!isLove) {
      ARKBAR_SLOTS.forEach(slot => { cells += buildCell(dateStr, slot, 'arkbar'); });
      HIP_SLOTS.forEach(slot => { cells += buildCell(dateStr, slot, 'hip'); });
    } else {
      LOVE_SAT_SLOTS.forEach(slot => {
        const isActive = isSat ? true : LOVE_WEEKDAY_SLOTS.includes(slot);
        if (isActive) {
          cells += buildCell(dateStr, slot, 'love');
        } else {
          cells += `<td class="td-slot empty-slot"></td>`;
        }
      });
    }

    bodyRows += `
      <tr>
        <td class="td-date ${isWeekend ? 'weekend' : ''}">
          <span class="dow">${DAYS[dow]}</span>
          ${d} ${MONTHS[currentMonth].slice(0,3)}
        </td>
        ${cells}
      </tr>`;
  }

  document.getElementById('mainContent').innerHTML = `
    <div class="grid-wrap">
      <table class="roster-table">
        <thead>
          ${venueHeaderRow}
          <tr>${slotHeaderRow}</tr>
        </thead>
        <tbody>${bodyRows}</tbody>
      </table>
    </div>`;
}

function buildCell(dateStr, slot, type) {
  // Each venue uses its own assignment map
  const assignMap = type === 'hip' ? hipAssignments : rosterAssignments;
  const key = `${dateStr}|${slot}`;
  const assigned = assignMap[key] || '';

  // Availability from the server map (regular DJs who submitted the form)
  const avail = (availability[dateStr] && availability[dateStr][slot]) || [];

  let options = [];

  if (type === 'arkbar') {
    // ARKbar: regular DJs from avail map + residents (unless blacked out)
    const regularDJs = avail.filter(dj => !LOVE_ONLY.includes(dj) && !RESIDENTS.includes(dj));
    options = [...regularDJs];
    // Add residents if not fully blacked out today
    RESIDENTS.forEach(res => {
      if (res === 'Sound Bogie' && SOUND_BOGIE_BLOCKED.includes(slot)) return;
      const blackout = residentBlackouts[res] && residentBlackouts[res][dateStr];
      if (blackout === 'full') return;
      if (blackout === 'morning' && MORNING_SLOTS.includes(slot)) return;
      if (!options.includes(res)) options.push(res);
    });

  } else if (type === 'hip') {
    // HIP: regular DJs from avail map + residents (with conflict warning if double-booked)
    // Residents CAN play HIP but we flag if they're already at ARKbar that slot
    const regularDJs = avail.filter(dj => !LOVE_ONLY.includes(dj));
    options = [...regularDJs];
    // Add residents — they may be assigned here even if at ARKbar (manager decides)
    RESIDENTS.forEach(res => {
      const blackout = residentBlackouts[res] && residentBlackouts[res][dateStr];
      if (blackout === 'full') return;
      if (!options.includes(res)) options.push(res);
    });

  } else if (type === 'love') {
    // Love: regular DJs from avail map (no ARKBAR_ONLY) + residents
    const regularDJs = avail.filter(dj => !ARKBAR_ONLY.includes(dj) && !RESIDENTS.includes(dj));
    options = [...regularDJs];
    RESIDENTS.forEach(res => {
      const blackout = residentBlackouts[res] && residentBlackouts[res][dateStr];
      if (blackout === 'full') return;
      if (!options.includes(res)) options.push(res);
    });
  }

  const isHip = type === 'hip';
  const isLove = type === 'love';
  const tdClass = `td-slot${isHip ? ' hip-slot' : isLove ? ' love-slot' : ''}`;

  if (options.length === 0 && !assigned) {
    return `<td class="${tdClass} empty-slot">
      <select class="slot-select no-avail" disabled title="No DJs available">
        <option>—</option>
      </select></td>`;
  }

  const color = assigned ? (DJ_COLORS[assigned] || '#555') : '';
  const selClass = `slot-select ${assigned ? 'assigned' : 'unassigned'}`;
  const styleAttr = assigned ? `style="background:${color};border-color:${color}"` : '';
  const slotEsc = slot.replace(/"/g, '&quot;');

  let opts = `<option value="">— assign —</option>`;
  options.forEach(dj => {
    // For HIP/Love: flag if resident is already booked at ARKbar this slot
    const arkKey = `${dateStr}|${slot}`;
    const arkBooked = RESIDENTS.includes(dj) && (type === 'hip' || type === 'love')
      && arkbarAssignments[arkKey] === dj;
    const label = arkBooked ? `${dj} ⚠ ARKbar` : dj;
    opts += `<option value="${dj}"${dj === assigned ? ' selected' : ''}>${label}</option>`;
  });
  if (assigned && !options.includes(assigned)) {
    opts += `<option value="${assigned}" selected>${assigned} ⚠</option>`;
  }

  return `<td class="${tdClass}">
    <select class="${selClass}" ${styleAttr}
      data-date="${dateStr}" data-slot="${slotEsc}" data-type="${type}"
      onchange="assignDJ(this)">
      ${opts}
    </select></td>`;
}

async function assignDJ(sel) {
  if (isPublished) return;

  const date = sel.dataset.date;
  const slot = sel.dataset.slot;
  const type = sel.dataset.type;
  const dj = sel.value;
  const key = `${date}|${slot}`;
  const venueParam = type === 'hip' ? 'hip' : type === 'love' ? 'love' : 'arkbar';

  if (dj) {
    if (LOVE_ONLY.includes(dj) && type !== 'love') {
      showToast(`${dj} only plays Love Beach Club`, 'error');
      sel.value = ''; return;
    }
    if (ARKBAR_ONLY.includes(dj) && type === 'love') {
      showToast(`${dj} only plays ARKbar / HIP`, 'error');
      sel.value = ''; return;
    }

    const dayAssignments = Object.entries(rosterAssignments)
      .filter(([k, v]) => k.startsWith(date) && v === dj);
    if (dayAssignments.length >= 5) {
      showToast(`${dj} already has 5 slots on this day`, 'error');
      sel.value = ''; return;
    }

    const combinedTimeline = [
      '14:00\u201315:00','15:00\u201316:00','16:00\u201317:00','17:00\u201318:00',
      '18:00\u201319:00','20:00\u201321:00','21:00\u201322:00',
      '22:00\u201323:00','23:00\u201300:00','00:00\u201301:00','01:00\u201302:00'
    ];
    const isSat = new Date(date).getDay() === 6;
    const allSlots = type === 'love' ? (isSat ? [...LOVE_SAT_SLOTS] : [...LOVE_WEEKDAY_SLOTS]) : combinedTimeline;
    const slotIdx = allSlots.indexOf(slot);

    if (slotIdx >= 0) {
      let before = 0, after = 0;
      for (let i = slotIdx - 1; i >= 0; i--) {
        if (rosterAssignments[`${date}|${allSlots[i]}`] === dj) before++; else break;
      }
      for (let i = slotIdx + 1; i < allSlots.length; i++) {
        if (rosterAssignments[`${date}|${allSlots[i]}`] === dj) after++; else break;
      }
      if (before + after >= 3) {
        showToast(`${dj} can't play more than 3 slots in a row`, 'error');
        sel.value = ''; return;
      }
    }

    if (slotIdx >= 0) {
      const existingIdxs = allSlots
        .map((s, i) => rosterAssignments[`${date}|${s}`] === dj ? i : -1)
        .filter(i => i >= 0);
      if (existingIdxs.length > 0) {
        const min = Math.min(...existingIdxs);
        const max = Math.max(...existingIdxs);
        if (slotIdx !== min - 1 && slotIdx !== max + 1) {
          showToast(`${dj}'s slots must be one unbroken block`, 'error');
          sel.value = ''; return;
        }
      }
    }

    if (type === 'hip' && rosterAssignments[`${date}|${slot}`] === dj) {
      showToast(`${dj} is already on ARKbar at ${slot}`, 'error');
      sel.value = ''; return;
    }

    const otherAssignments = Object.entries(type === 'love' ? arkbarAssignments : loveAssignments)
      .filter(([k, v]) => k.startsWith(date) && v === dj);
    if (otherAssignments.length > 0) {
      const otherVenue = type === 'love' ? 'ARKbar' : 'Love Beach';
      showToast(`${dj} is already booked at ${otherVenue} on this date`, 'error');
      sel.value = ''; return;
    }
  }

  if (dj) {
    const color = DJ_COLORS[dj] || '#555';
    sel.className = 'slot-select assigned';
    sel.style.background = color;
    sel.style.borderColor = color;
    sel.style.color = 'white';
    rosterAssignments[key] = dj;
    if (venueParam === 'hip') hipAssignments[key] = dj;
    else if (venueParam === 'arkbar') arkbarAssignments[key] = dj;
    else loveAssignments[key] = dj;
  } else {
    sel.className = 'slot-select unassigned';
    sel.style.background = '';
    sel.style.borderColor = '';
    sel.style.color = '';
    delete rosterAssignments[key];
    if (venueParam === 'hip') delete hipAssignments[key];
    else if (venueParam === 'arkbar') delete arkbarAssignments[key];
    else delete loveAssignments[key];
  }

  try {
    const res = await fetch('/api/roster/assign', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ venue: venueParam, date, slot, dj, month: getMonthString() })
    });
    const data = await res.json();
    if (data.success) {
      showToast(dj ? `${dj} saved` : 'Cleared', 'success');
    } else {
      showToast('Save failed', 'error');
    }
  } catch(e) {
    showToast('Connection error', 'error');
  }
}

const FIXED_CONSTRAINTS = {
  'Tobi':  (dateStr, slot, type) => {
    const dow = new Date(dateStr).getDay();
    return type === 'hip' && dow === 4;
  },
  'Buba':  (dateStr, slot, type) => {
    const dow = new Date(dateStr).getDay();
    const hour = parseInt(slot.split(':')[0]);
    if (dow === 0) return false;
    if (dow === 1 && hour < 18) return false;
    return true;
  },
  'Vozka': (dateStr, slot, type) => {
    const dow = new Date(dateStr).getDay();
    return type === 'hip' && [1, 2, 5].includes(dow);
  },
};

async function clearRoster() {
  if (isPublished) {
    showToast('Unlock roster before clearing', 'error');
    return;
  }
  if (currentVenue === 'hours') return;

  const confirmed = confirm(`Clear ALL assignments for ${getMonthString()} — ${currentVenue === 'love' ? 'Love Beach' : 'ARKbar/HIP'}?\n\nThis cannot be undone.`);
  if (!confirmed) return;

  showToast('Clearing roster...', '');
  const venueParam = currentVenue === 'love' ? 'love' : 'arkbar';
  const month = getMonthString();

  try {
    // ARKbar view clears both ARKbar and HIP tabs (separate sheets, same view)
    const venuesToClear = venueParam === 'arkbar' ? ['arkbar', 'hip'] : [venueParam];
    await Promise.all(venuesToClear.map(v =>
      fetch('/api/roster/clear', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ venue: v, month })
      })
    ));

    rosterAssignments = {};
    if (venueParam === 'arkbar') { arkbarAssignments = {}; hipAssignments = {}; }
    else loveAssignments = {};

    renderGrid();
    showToast('Roster cleared', 'success');
  } catch(e) {
    rosterAssignments = {};
    if (venueParam === 'arkbar') { arkbarAssignments = {}; hipAssignments = {}; }
    else loveAssignments = {};
    renderGrid();
    showToast('Cleared locally — check connection', 'error');
  }
}

async function suggestRoster() {
  if (isPublished) {
    showToast('Unlock roster before auto-suggesting', 'error');
    return;
  }
  if (currentVenue === 'hours') {
    showToast('Switch to a venue tab first', 'error');
    return;
  }

  showToast('Auto-suggesting ARKbar slots...', '');

  const isLove = currentVenue === 'love';
  const month = getMonthString();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  const allSlots = [];
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(currentYear, currentMonth, d);
    const dow = date.getDay();
    const isSat = dow === 6;
    const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if (!isLove) {
      // ARKbar only — HIP is MANUAL ONLY (HIP and ARKbar share slot labels,
      // auto-suggest cannot distinguish them safely, so HIP is never auto-filled)
      ARKBAR_AUTOSUGGEST_SLOTS.forEach(slot => allSlots.push({ dateStr, slot, type: 'arkbar' }));
    } else {
      const active = isSat ? LOVE_SAT_SLOTS : LOVE_WEEKDAY_SLOTS;
      active.forEach(slot => allSlots.push({ dateStr, slot, type: 'love' }));
    }
  }

  const emptySlots = allSlots.filter(({ dateStr, slot }) => !rosterAssignments[`${dateStr}|${slot}`]);
  if (emptySlots.length === 0) {
    showToast('No empty slots to fill', '');
    return;
  }

  const eligibleDJs = djList
    .map(d => d.name)
    .filter(name => {
      if (name === 'Guest DJ') return false;
      if (isLove && ARKBAR_ONLY.includes(name)) return false;
      if (!isLove && LOVE_ONLY.includes(name)) return false;
      return true;
    });

  const djHours = {};
  eligibleDJs.forEach(name => { djHours[name] = 0; });
  Object.values(rosterAssignments).forEach(dj => {
    if (djHours[dj] !== undefined) djHours[dj]++;
  });

  const working = { ...rosterAssignments };
  const otherVenue = { ...(isLove ? arkbarAssignments : loveAssignments) };

  const COMBINED_ARK_HIP = [
    '14:00\u201315:00','15:00\u201316:00','16:00\u201317:00','17:00\u201318:00',
    '18:00\u201319:00','20:00\u201321:00','21:00\u201322:00',
    '22:00\u201323:00','23:00\u201300:00','00:00\u201301:00','01:00\u201302:00'
  ];

  function consecutiveAround(djName, dateStr, slot, type) {
    let slotList;
    if (type === 'love') {
      slotList = new Date(dateStr).getDay() === 6 ? LOVE_SAT_SLOTS : LOVE_WEEKDAY_SLOTS;
    } else {
      slotList = COMBINED_ARK_HIP;
    }
    const idx = slotList.indexOf(slot);
    if (idx < 0) return 1;
    let count = 1;
    for (let i = idx - 1; i >= 0; i--) {
      if (working[`${dateStr}|${slotList[i]}`] === djName) count++; else break;
    }
    for (let i = idx + 1; i < slotList.length; i++) {
      if (working[`${dateStr}|${slotList[i]}`] === djName) count++; else break;
    }
    return count;
  }

  function slotsOnDay(djName, dateStr) {
    return Object.entries(working).filter(([k, v]) => k.startsWith(dateStr + '|') && v === djName).length;
  }

  function wouldCreateGap(djName, dateStr, slot, type) {
    const slotList = type === 'love'
      ? (new Date(dateStr).getDay() === 6 ? LOVE_SAT_SLOTS : LOVE_WEEKDAY_SLOTS)
      : COMBINED_ARK_HIP;
    const djSlots = slotList.filter(s => s === slot || working[`${dateStr}|${s}`] === djName);
    if (djSlots.length <= 1) return false;
    const indices = djSlots.map(s => slotList.indexOf(s)).filter(i => i >= 0).sort((a,b) => a-b);
    for (let i = 1; i < indices.length; i++) {
      if (indices[i] !== indices[i-1] + 1) return true;
    }
    return false;
  }

  function canAssign(djName, dateStr, slot, type) {
    // Hard rules for everyone
    if (working[`${dateStr}|${slot}`] === djName) return false;
    if (Object.entries(otherVenue).some(([k, v]) => k.startsWith(dateStr + '|') && v === djName)) return false;
    if (isLove && ARKBAR_ONLY.includes(djName)) return false;
    if (!isLove && LOVE_ONLY.includes(djName)) return false;
    if (NO_HIP.includes(djName) && type === 'hip') return false;
    if (slotsOnDay(djName, dateStr) >= 5) return false;
    if (consecutiveAround(djName, dateStr, slot, type) > 3) return false;
    if (wouldCreateGap(djName, dateStr, slot, type)) return false;

    const isResident = RESIDENTS.includes(djName);

    if (isResident) {
      // Residents: availability is managed by blackout system on the server.
      // They are always available for ARKbar slots unless blacked out.
      // The server injected them into non-HIP slots only — but for auto-suggest
      // we check the availability map which may or may not have them for late night.
      // Instead: residents are always eligible for ARKbar non-HIP slots.
      if (type === 'hip') return false; // never in HIP
      if (djName === 'Sound Bogie' && SOUND_BOGIE_BLOCKED.includes(slot)) return false;
      if (djName === 'Sound Bogie' && djHours['Sound Bogie'] >= SOUND_BOGIE_TARGET) return false;
      if (RESIDENTS_LATE_NIGHT.includes(djName) && djHours[djName] >= RESIDENT_TARGET) return false;
      // Check blackout: if resident not in availability map at all for this date/slot,
      // they may be blacked out — but the server injects them if available,
      // so check if they appear in ANY slot for this date (not necessarily this slot)
      // Actually: just check the avail map — server puts them in non-HIP slots when available
      const dayAvail = availability[dateStr] || {};
      const anySlotAvail = Object.values(dayAvail).some(arr => Array.isArray(arr) && arr.includes(djName));
      if (!anySlotAvail) return false; // fully blacked out this day
      return true;
    }

    // Regular DJs: must be in the availability map for this specific slot
    const avail = (availability[dateStr] && availability[dateStr][slot]) || [];
    const filtered = isLove ? avail.filter(d => !ARKBAR_ONLY.includes(d)) : avail.filter(d => !LOVE_ONLY.includes(d));
    if (!filtered.includes(djName)) return false;
    return true;
  }

  const LATE_NIGHT_PRIORITY = ['23:00–00:00','00:00–01:00','01:00–02:00'];
  const EVENING_SLOTS = ['20:00–21:00','21:00–22:00','22:00–23:00'];

  function slotPriority(slot) {
    if (LATE_NIGHT_PRIORITY.includes(slot)) return 0;
    if (EVENING_SLOTS.includes(slot)) return 1;
    if (SOUND_BOGIE_RARE.includes(slot)) return 2;
    return 3;
  }

  const sorted = [...emptySlots].sort((a, b) => slotPriority(a.slot) - slotPriority(b.slot));

  const fairShare = Math.ceil(emptySlots.length / Math.max(eligibleDJs.length, 1));
  const runCap = Math.max(fairShare, 20);
  const runCount = {};

  function djScore(djName, slot) {
    const hours = djHours[djName] || 0;
    const isLateNight = LATE_NIGHT_PRIORITY.includes(slot);
    const isSoundBogie = djName === 'Sound Bogie';
    const isLateNightRes = RESIDENTS_LATE_NIGHT.includes(djName);

    if (isSoundBogie && SOUND_BOGIE_RARE.includes(slot)) return 900 + hours;
    if (isLateNightRes && isLateNight && hours < RESIDENT_TARGET) return hours - 50;
    if (RESIDENTS.includes(djName)) {
      const target = isSoundBogie ? SOUND_BOGIE_TARGET : RESIDENT_TARGET;
      if (hours < target) return hours;
      return 500 + hours;
    }
    return 200 + hours + Math.random() * 5;
  }

  function pickDJ(dateStr, slot, type) {
    // Build candidate pool from all eligible DJs — canAssign handles all rules
    const candidates = eligibleDJs.filter(dj =>
      canAssign(dj, dateStr, slot, type) &&
      (runCount[dj] || 0) < runCap
    );
    const pool = candidates.length > 0 ? candidates :
      eligibleDJs.filter(dj => canAssign(dj, dateStr, slot, type));
    if (pool.length === 0) return null;
    pool.sort((a, b) => djScore(a, slot) - djScore(b, slot));
    return pool[0];
  }

  const toSave = [];
  for (const { dateStr, slot, type } of sorted) {
    const chosen = pickDJ(dateStr, slot, type);
    if (chosen) {
      working[`${dateStr}|${slot}`] = chosen;
      djHours[chosen] = (djHours[chosen] || 0) + 1;
      runCount[chosen] = (runCount[chosen] || 0) + 1;
      toSave.push({ dateStr, slot, type, dj: chosen });
    }
  }

  const residentTargets = {
    'Alex RedWhite': RESIDENT_TARGET,
    'Raffo DJ': RESIDENT_TARGET,
    'Sound Bogie': SOUND_BOGIE_TARGET,
  };
  const residentsUnder = RESIDENTS.filter(r => {
    if (isLove) return false;
    return djHours[r] < residentTargets[r];
  });
  if (residentsUnder.length > 0) {
    const stillEmpty = sorted.filter(({ dateStr, slot }) => !working[`${dateStr}|${slot}`]);
    for (const { dateStr, slot, type } of stillEmpty) {
      if (type === 'hip') continue;
      const avail = (availability[dateStr] && availability[dateStr][slot]) || [];
      const eligible = residentsUnder.filter(res => {
        if (type === 'hip') return false;
        if (NO_HIP.includes(res) && type === 'hip') return false;
        if (res === 'Sound Bogie' && SOUND_BOGIE_BLOCKED.includes(slot)) return false;
        if (slotsOnDay(res, dateStr) >= 5) return false;
        if (consecutiveAround(res, dateStr, slot, type) > 3) return false;
        if (wouldCreateGap(res, dateStr, slot, type)) return false;
        if (Object.entries(otherVenue).some(([k, v]) => k.startsWith(dateStr + '|') && v === res)) return false;
        if (djHours[res] >= residentTargets[res]) return false;
        // Check not fully blacked out this day
        const dayAvail = availability[dateStr] || {};
        const anySlot = Object.values(dayAvail).some(arr => Array.isArray(arr) && arr.includes(res));
        if (!anySlot) return false;
        return true;
      });
      eligible.sort((a, b) => djScore(a, slot) - djScore(b, slot));
      if (eligible.length > 0) {
        const res = eligible[0];
        working[`${dateStr}|${slot}`] = res;
        djHours[res] = (djHours[res] || 0) + 1;
        runCount[res] = (runCount[res] || 0) + 1;
        toSave.push({ dateStr, slot, type, dj: res });
      }
    }
  }

  if (toSave.length === 0) {
    showToast('No available DJs found for empty slots', 'error');
    return;
  }

  rosterAssignments = { ...working };
  renderGrid();
  showToast(`Saving ${toSave.length} slots...`, 'success');

  const venueParam = isLove ? 'love' : 'arkbar';
  try {
    const res = await fetch('/api/roster/batch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        venue: venueParam,
        month,
        assignments: toSave.map(({ dateStr, slot, dj, type }) => ({ date: dateStr, slot, dj, type }))
      })
    });
    const data = await res.json();
    if (data.success) {
      showToast(`Done: ${toSave.length} slots filled`, 'success');
    } else {
      showToast(`UI updated — sheet sync failed: ${data.error}`, 'error');
    }
  } catch(e) {
    showToast('UI updated — check connection', 'error');
  }
}

let isPublished = false;

function publishRoster() {
  if (!isPublished) {
    isPublished = true;
    document.getElementById('statusPill').className = 'status-pill published';
    document.getElementById('statusPill').textContent = '● Published';
    document.getElementById('statusText').textContent = `Published — ${MONTHS[currentMonth]} ${currentYear}`;
    document.getElementById('btnPublish').textContent = 'Unlock Roster';
    document.getElementById('btnPrint').style.display = 'inline-block';
    document.getElementById('mainContent').classList.add('roster-locked');
    showToast('Roster published — locked for editing', 'success');
  } else {
    isPublished = false;
    document.getElementById('statusPill').className = 'status-pill draft';
    document.getElementById('statusPill').textContent = '● Draft';
    document.getElementById('statusText').textContent = 'Unsaved changes will auto-save per cell';
    document.getElementById('btnPublish').textContent = 'Publish Roster';
    document.getElementById('btnPrint').style.display = 'none';
    document.getElementById('mainContent').classList.remove('roster-locked');
    showToast('Roster unlocked for editing', '');
  }
}

function printRoster() {
  const venue = currentVenue === 'arkbar' ? 'ARKbar / HIP Restaurant' : 'Love Beach Club';
  const header = document.getElementById('printHeader');
  if (header) {
    header.textContent = `${venue}  —  DJ Roster  —  ${MONTHS[currentMonth]} ${currentYear}`;
  }
  setTimeout(() => window.print(), 100);
}

const RESIDENTS = ['Alex RedWhite', 'Raffo DJ', 'Sound Bogie'];
const SOUND_BOGIE_TARGET = 35;
const LATE_NIGHT_SLOTS = ['23:00–00:00','00:00–01:00','01:00–02:00'];
const RESIDENTS_80HR = ['Alex RedWhite', 'Raffo DJ'];
const RESIDENT_TARGET = 80;

async function loadHours() {
  document.getElementById('mainContent').innerHTML =
    '<div class="loading"><div class="spinner"></div>Loading hours...</div>';
  const month = getMonthString();
  try {
    const [arkRes, loveRes, djRes] = await Promise.all([
      fetch(`/api/roster?venue=arkbar&month=${encodeURIComponent(month)}`),
      fetch(`/api/roster?venue=love&month=${encodeURIComponent(month)}`),
      fetch('/api/djs')
    ]);
    const arkData  = await arkRes.json();
    const loveData = await loveRes.json();
    const djData   = await djRes.json();

    const arkHours = {}, loveHours = {};
    (arkData.roster || []).forEach(r => { if (r[2]) arkHours[r[2]] = (arkHours[r[2]] || 0) + 1; });
    (loveData.roster || []).forEach(r => { if (r[2]) loveHours[r[2]] = (loveHours[r[2]] || 0) + 1; });

    renderHours(djData.djs || [], arkHours, loveHours);
  } catch(e) {
    document.getElementById('mainContent').innerHTML = `<div class="loading">Error: ${e.message}</div>`;
  }
}

function renderHours(djs, arkHours, loveHours) {
  const normalize = name => name ? name.trim().toLowerCase() : '';

  const arkHoursNorm = {};
  const loveHoursNorm = {};
  Object.entries(arkHours).forEach(([k, v]) => { arkHoursNorm[normalize(k)] = v; });
  Object.entries(loveHours).forEach(([k, v]) => { loveHoursNorm[normalize(k)] = v; });

  const totals = {};
  djs.forEach(d => {
    const n = normalize(d.name);
    totals[d.name] = (arkHoursNorm[n] || 0) + (loveHoursNorm[n] || 0);
  });

  const totalHours = Object.values(totals).reduce((a, b) => a + b, 0);
  const totalCost  = djs.reduce((sum, d) => sum + (totals[d.name] || 0) * d.rate, 0);
  const maxHours   = Math.max(...Object.values(totals), RESIDENT_TARGET);

  const sorted = [...djs].sort((a, b) => {
    const aR = RESIDENTS.includes(a.name) ? 1 : 0;
    const bR = RESIDENTS.includes(b.name) ? 1 : 0;
    if (aR !== bR) return bR - aR;
    return (totals[b.name] || 0) - (totals[a.name] || 0);
  });

  const rows = sorted.map(dj => {
    const ark  = arkHoursNorm[normalize(dj.name)] || 0;
    const love = loveHoursNorm[normalize(dj.name)] || 0;
    const total = ark + love;
    const isResident = RESIDENTS.includes(dj.name);
    const has80Target = RESIDENTS_80HR.includes(dj.name);
    const pct = maxHours > 0 ? Math.min(total / maxHours * 100, 100) : 0;
    const cost = total * dj.rate;
    const barClass = `hours-bar-fill${isResident ? ' resident' : total === 0 ? ' zero' : ''}`;
    const isSoundBogie = dj.name === 'Sound Bogie';
    const djTarget = isSoundBogie ? 35 : RESIDENT_TARGET;
    const djTargetLabel = isSoundBogie ? '30–40' : RESIDENT_TARGET;
    let badge = '';
    if (has80Target || isSoundBogie) {
      if (total >= djTarget) {
        badge = `<span class="badge badge-ok">${total}/${djTargetLabel}h ✓</span>`;
      } else {
        const rem = djTarget - total;
        badge = `<span class="badge badge-low">${total}/${djTargetLabel}h</span><span style="margin-left:6px;padding:2px 8px;border-radius:20px;font-size:9px;font-weight:800;background:#fff8e1;color:#f57f17;border:1px solid #ffe082">${rem}h needed</span>`;
      }
    }
    return `<tr>
      <td><div class="dj-name-cell">
        <div class="dj-dot" style="background:${DJ_COLORS[dj.name]||'#aaa'}"></div>
        <div>
          <div class="dj-name">${dj.name}</div>
          ${isResident ? '<div style="font-size:9px;color:var(--teal);font-weight:800;text-transform:uppercase;letter-spacing:0.06em">Resident</div>' : ''}
        </div>
      </div></td>
      <td class="right">${ark > 0 ? ark + 'h' : '—'}</td>
      <td class="right">${love > 0 ? love + 'h' : '—'}</td>
      <td><div class="hours-bar-wrap">
        <div class="hours-bar-bg"><div class="${barClass}" style="width:${pct}%"></div></div>
        <div class="hours-val">${total}h</div>
        ${badge}
      </div></td>
      <td class="right" style="color:var(--text-mid)">฿${dj.rate.toLocaleString()}/h</td>
      <td class="right" style="font-weight:800;color:var(--navy)">${total > 0 ? '฿'+cost.toLocaleString() : '—'}</td>
    </tr>`;
  }).join('');

  const arkTotal  = Object.values(arkHours).reduce((a,b)=>a+b,0);
  const loveTotal = Object.values(loveHours).reduce((a,b)=>a+b,0);

  document.getElementById('mainContent').innerHTML = `
    <div class="hours-wrap">
      <div class="summary-row">
        <div class="summary-card">
          <div class="card-label">Total Hours</div>
          <div class="card-value">${totalHours}h</div>
          <div class="card-sub">${getMonthString()}</div>
        </div>
        <div class="summary-card">
          <div class="card-label">Total Cost</div>
          <div class="card-value" style="font-size:20px">฿${totalCost.toLocaleString()}</div>
          <div class="card-sub">All venues</div>
        </div>
        <div class="summary-card">
          <div class="card-label">ARKbar / HIP</div>
          <div class="card-value">${arkTotal}h</div>
          <div class="card-sub">Hours booked</div>
        </div>
        <div class="summary-card">
          <div class="card-label">Love Beach</div>
          <div class="card-value">${loveTotal}h</div>
          <div class="card-sub">Hours booked</div>
        </div>
      </div>
      <div class="hours-table-wrap">
        <div class="hours-table-header">
          <h2>Hours by DJ — ${getMonthString()}</h2>
        </div>
        <table class="hours-table">
          <thead><tr>
            <th>DJ</th>
            <th class="right">ARKbar/HIP</th>
            <th class="right">Love Beach</th>
            <th>Total Hours</th>
            <th class="right">Rate</th>
            <th class="right">Total Cost</th>
          </tr></thead>
          <tbody>
            ${rows}
            <tr class="totals-row">
              <td>Total</td>
              <td class="right">${arkTotal}h</td>
              <td class="right">${loveTotal}h</td>
              <td><div class="hours-val" style="font-size:14px;color:var(--navy)">${totalHours}h</div></td>
              <td></td>
              <td class="right" style="font-size:14px;color:var(--navy)">฿${totalCost.toLocaleString()}</td>
            </tr>
          </tbody>
        </table>
        <div class="target-note">Targets: Alex RedWhite & Raffo DJ — ${RESIDENT_TARGET}h/month · Sound Bogie — 30–40h/month</div>
      </div>
    </div>`;
}

let toastTimer;
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
